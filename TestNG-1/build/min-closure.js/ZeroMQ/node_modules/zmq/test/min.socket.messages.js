'use strict';var zmq=require(".."),should=require("should"),semver=require("semver");
describe("socket.messages",function(){var b,d;beforeEach(function(){b=zmq.socket("push");d=zmq.socket("pull")});it("should support messages",function(e){var c=0;d.on("message",function(a){a=a.toString();switch(c++){case 0:a.should.equal("string");break;case 1:a.should.equal("15.99");break;case 2:a.should.equal("buffer"),b.close(),d.close(),e()}});d.bind("inproc://stuff_ssm",function(a){if(a)throw a;b.connect("inproc://stuff_ssm");b.send("string");b.send(15.99);b.send(new Buffer("buffer"))})});it("should support multipart messages",
function(e){d.on("message",function(c,a,f){c.toString().should.equal("string");a.toString().should.equal("15.99");f.toString().should.equal("buffer");b.close();d.close();e()});d.bind("inproc://stuff_ssmm",function(c){if(c)throw c;b.connect("inproc://stuff_ssmm");b.send(["string",15.99,new Buffer("buffer")])})});it("should support sndmore",function(e){d.on("message",function(c,a,f,g,h){c.toString().should.equal("tobi");a.toString().should.equal("loki");f.toString().should.equal("jane");g.toString().should.equal("luna");
h.toString().should.equal("manny");b.close();d.close();e()});d.bind("inproc://stuff_sss",function(c){if(c)throw c;b.connect("inproc://stuff_sss");b.send(["tobi","loki"],zmq.ZMQ_SNDMORE);b.send(["jane","luna"],zmq.ZMQ_SNDMORE);b.send("manny")})});it("should handle late connect",function(e){var c=0;d.on("message",function(a){a=a.toString();switch(c++){case 0:a.should.equal("string");break;case 1:a.should.equal("15.99");break;case 2:a.should.equal("buffer"),b.close(),d.close(),e()}});semver.satisfies(zmq.version,
"\x3e\x3d3.x")?(b.setsockopt(zmq.ZMQ_SNDHWM,1),d.setsockopt(zmq.ZMQ_RCVHWM,1)):semver.satisfies(zmq.version,"2.x")&&(b.setsockopt(zmq.ZMQ_HWM,1),d.setsockopt(zmq.ZMQ_HWM,1));b.bind("tcp://127.0.0.1:12345",function(a){if(a)throw a;b.send("string");b.send(15.99);b.send(new Buffer("buffer"));d.connect("tcp://127.0.0.1:12345")})});it("should call send() callbacks",function(e){function c(){f+=1}var a=0,f=0;d.on("message",function(){a+=1;4===a&&(f.should.equal(a),e())});d.bind("inproc://stuff_ssmm",function(a){if(a)throw a;
b.connect("inproc://stuff_ssmm");b.send("hello",null,c);b.send("hello",null,c);b.send("hello",null,c);b.send(["hello","world"],null,c)})})});