'use strict';var zmq=require(".."),should=require("should"),semver=require("semver");
describe("socket.zap",function(){var f=require("./zap"),d,a,b,e=0;beforeEach(function(){e++;d=f.start(e);a=zmq.socket("rep");b=zmq.socket("req")});afterEach(function(){b.close();a.close();d.close()});it("should support curve",function(c){if(semver.gte(zmq.version,"4.0.0")){try{a.curve_server=0}catch(k){console.log("libsodium seems to be missing (skipping curve test)");c();return}var g=new Buffer("7f188e5244b02bf497b86de417515cf4d4053ce4eb977aee91a55354655ec33a","hex"),h=new Buffer("1f5d3873472f95e11f4723d858aaf0919ab1fb402cb3097742c606e61dd0d7d8",
"hex"),d=new Buffer("ea1cc8bd7c8af65497d43fc21dbec6560c5e7b61bcfdcbd2b0dfacf0b4c38d45","hex"),e=new Buffer("83f99afacfab052406e5f421612568034e85f4c8182a1c92671e83dca669d31d","hex");a.on("message",function(b){b.should.be.an.instanceof(Buffer);b.toString().should.equal("hello");a.send("world")});a.zap_domain="test";a.curve_server=1;a.curve_secretkey=h;a.mechanism.should.eql(2);a.bind("tcp://127.0.0.1:12347",function(a){if(a)throw a;b.curve_serverkey=g;b.curve_publickey=d;b.curve_secretkey=e;b.mechanism.should.eql(2);
b.connect("tcp://127.0.0.1:12347");b.send("hello");b.on("message",function(a){a.should.be.an.instanceof(Buffer);a.toString().should.equal("world");c()})})}else c()});it("should support null",function(c){semver.gte(zmq.version,"4.0.0")?(a.on("message",function(b){b.should.be.an.instanceof(Buffer);b.toString().should.equal("hello");a.send("world")}),a.zap_domain="test",a.mechanism.should.eql(0),a.bind("tcp://127.0.0.1:12345",function(a){if(a)throw a;b.mechanism.should.eql(0);b.connect("tcp://127.0.0.1:12345");
b.send("hello");b.on("message",function(a){a.should.be.an.instanceof(Buffer);a.toString().should.equal("world");c()})})):c()});it("should support plain",function(c){semver.gte(zmq.version,"4.0.0")?(a.on("message",function(b){b.should.be.an.instanceof(Buffer);b.toString().should.equal("hello");a.send("world")}),a.zap_domain="test",a.plain_server=1,a.mechanism.should.eql(1),a.bind("tcp://127.0.0.1:12346",function(a){if(a)throw a;b.plain_username="user";b.plain_password="pass";b.mechanism.should.eql(1);
b.connect("tcp://127.0.0.1:12346");b.send("hello");b.on("message",function(a){a.should.be.an.instanceof(Buffer);a.toString().should.equal("world");c()})})):c()})});