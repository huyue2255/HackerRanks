'use strict';var zmq=require(".."),should=require("should"),semver=require("semver");
describe("socket.router",function(){it("should handle the unroutable",function(f){function c(a){if(-1===b.indexOf(a.message))throw Error("Bad error");}var d=0;if(!semver.gte(zmq.version,"3.2.0"))return f(),console.warn("Test requires libzmq \x3e\x3d 3.2.0");if(semver.eq(zmq.version,"3.2.1"))return f(),console.warn("ZMQ_ROUTER_MANDATORY is broken in libzmq \x3d 3.2.1");var b="win32"===require("os").platform()?["Unknown error"]:[];b.push("No route to host");b.push("Resource temporarily unavailable");
(function(){var a=zmq.socket("router");a.on("error",function(e){a.close();c(e);2===++d&&f()});a.setsockopt(zmq.ZMQ_ROUTER_MANDATORY,1);a.send(["12384982398293",""])})();(function(){var a=zmq.socket("router");a.setsockopt(zmq.ZMQ_ROUTER_MANDATORY,1);try{a.send(["12384982398293",""])}catch(e){c(e)}try{a.send(["12384982398293",""])}catch(e){c(e)}try{a.send(["12384982398293",""])}catch(e){c(e)}a.close()})();(function(){var a=zmq.socket("router");(function(){a.send(["12384982398293",""]);a.close()}).should.not.throw})();
2===++d&&f()});it("should handle router \x3c-\x3e dealer message bursts",function(f){var c=zmq.socket("router"),d=zmq.socket("dealer"),b=0;c.bindSync("tcp://127.0.0.1:12345");c.on("message",function(){for(var a=[],b=0;b<arguments.length;b+=1)a.push(arguments[b]);c.send(a)});d.on("message",function(a,g,h,k,l){String(a).should.equal("Hello");String(g).should.equal("world");String(h).should.equal("part3");String(k).should.equal("part4");String(l).should.equal("undefined");b+=1;1E3===b&&(c.close(),d.close(),
f())});d.connect("tcp://127.0.0.1:12345");for(var a=0;1E3>a;a+=1)d.send(["Hello","world","part3","part4"])})});