'use strict';var EventEmitter=require("events").EventEmitter,zmq=require("bindings")("zmq.node"),util=require("util");exports=module.exports=zmq;exports.version=zmq.zmqVersion();exports.curveKeypair=zmq.zmqCurveKeypair;
var types=exports.types={pub:zmq.ZMQ_PUB,xpub:zmq.ZMQ_XPUB,sub:zmq.ZMQ_SUB,xsub:zmq.ZMQ_XSUB,req:zmq.ZMQ_REQ,xreq:zmq.ZMQ_XREQ,rep:zmq.ZMQ_REP,xrep:zmq.ZMQ_XREP,push:zmq.ZMQ_PUSH,pull:zmq.ZMQ_PULL,dealer:zmq.ZMQ_DEALER,router:zmq.ZMQ_ROUTER,pair:zmq.ZMQ_PAIR,stream:zmq.ZMQ_STREAM},longOptions={ZMQ_HWM:1,ZMQ_SWAP:3,ZMQ_AFFINITY:4,ZMQ_IDENTITY:5,ZMQ_SUBSCRIBE:6,ZMQ_UNSUBSCRIBE:7,ZMQ_RATE:8,ZMQ_RECOVERY_IVL:9,ZMQ_MCAST_LOOP:10,ZMQ_SNDBUF:11,ZMQ_RCVBUF:12,ZMQ_RCVMORE:13,ZMQ_FD:14,ZMQ_EVENTS:15,ZMQ_TYPE:16,
ZMQ_LINGER:17,ZMQ_RECONNECT_IVL:18,ZMQ_BACKLOG:19,ZMQ_RECOVERY_IVL_MSEC:20,ZMQ_RECONNECT_IVL_MAX:21,ZMQ_MAXMSGSIZE:22,ZMQ_SNDHWM:23,ZMQ_RCVHWM:24,ZMQ_MULTICAST_HOPS:25,ZMQ_RCVTIMEO:27,ZMQ_SNDTIMEO:28,ZMQ_IPV4ONLY:31,ZMQ_LAST_ENDPOINT:32,ZMQ_ROUTER_MANDATORY:33,ZMQ_TCP_KEEPALIVE:34,ZMQ_TCP_KEEPALIVE_CNT:35,ZMQ_TCP_KEEPALIVE_IDLE:36,ZMQ_TCP_KEEPALIVE_INTVL:37,ZMQ_TCP_ACCEPT_FILTER:38,ZMQ_DELAY_ATTACH_ON_CONNECT:39,ZMQ_XPUB_VERBOSE:40,ZMQ_ROUTER_RAW:41,ZMQ_IPV6:42,ZMQ_MECHANISM:43,ZMQ_PLAIN_SERVER:44,
ZMQ_PLAIN_USERNAME:45,ZMQ_PLAIN_PASSWORD:46,ZMQ_CURVE_SERVER:47,ZMQ_CURVE_PUBLICKEY:48,ZMQ_CURVE_SECRETKEY:49,ZMQ_CURVE_SERVERKEY:50,ZMQ_ZAP_DOMAIN:55,ZMQ_IO_THREADS:1,ZMQ_MAX_SOCKETS:2};Object.keys(longOptions).forEach(function(a){Object.defineProperty(zmq,a,{enumerable:!0,configurable:!1,writable:!1,value:longOptions[a]})});
var opts=exports.options={_fd:zmq.ZMQ_FD,_ioevents:zmq.ZMQ_EVENTS,_receiveMore:zmq.ZMQ_RCVMORE,_subscribe:zmq.ZMQ_SUBSCRIBE,_unsubscribe:zmq.ZMQ_UNSUBSCRIBE,affinity:zmq.ZMQ_AFFINITY,backlog:zmq.ZMQ_BACKLOG,hwm:zmq.ZMQ_HWM,identity:zmq.ZMQ_IDENTITY,linger:zmq.ZMQ_LINGER,mcast_loop:zmq.ZMQ_MCAST_LOOP,rate:zmq.ZMQ_RATE,rcvbuf:zmq.ZMQ_RCVBUF,last_endpoint:zmq.ZMQ_LAST_ENDPOINT,reconnect_ivl:zmq.ZMQ_RECONNECT_IVL,recovery_ivl:zmq.ZMQ_RECOVERY_IVL,sndbuf:zmq.ZMQ_SNDBUF,swap:zmq.ZMQ_SWAP,mechanism:zmq.ZMQ_MECHANISM,
plain_server:zmq.ZMQ_PLAIN_SERVER,plain_username:zmq.ZMQ_PLAIN_USERNAME,plain_password:zmq.ZMQ_PLAIN_PASSWORD,curve_server:zmq.ZMQ_CURVE_SERVER,curve_publickey:zmq.ZMQ_CURVE_PUBLICKEY,curve_secretkey:zmq.ZMQ_CURVE_SECRETKEY,curve_serverkey:zmq.ZMQ_CURVE_SERVERKEY,zap_domain:zmq.ZMQ_ZAP_DOMAIN},events=exports.events={1:"connect",2:"connect_delay",4:"connect_retry",8:"listen",16:"bind_error",32:"accept",64:"accept_error",128:"close",256:"close_error",512:"disconnect"},ctx;
function defaultContext(){if(ctx)return ctx;var a=1;process.env.ZMQ_IO_THREADS&&(a=parseInt(process.env.ZMQ_IO_THREADS,10),!a||1>a)&&(console.warn("Invalid number in ZMQ_IO_THREADS, using 1 IO thread."),a=1);ctx=new zmq.Context(a);process.on("exit",function(){ctx=null});return ctx}function OutBatch(){this.content=[];this.cbs=[];this.isClosed=!1;this.next=null}
OutBatch.prototype.append=function(a,b,c){Buffer.isBuffer(a)||(a=new Buffer(String(a),"utf8"));this.content.push(a,b);c&&this.cbs.push(c);0===(b&zmq.ZMQ_SNDMORE)&&(this.isClosed=!0)};OutBatch.prototype.invokeError=function(a,b){for(var c=!1,d=0;d<this.cbs.length;d+=1)this.cbs[d].call(a,b),c=!0;if(!c)throw b;};OutBatch.prototype.invokeSent=function(a){for(var b=0;b<this.cbs.length;b+=1)this.cbs[b].call(a)};function BatchList(){this.lastBatch=this.firstBatch=null;this.length=0}
BatchList.prototype.canSend=function(){return this.firstBatch?this.firstBatch.isClosed:!1};BatchList.prototype.append=function(a,b,c){var d=this.lastBatch;if(!d||d.isClosed)d=new OutBatch,this.lastBatch&&(this.lastBatch.next=d),this.lastBatch=d,this.firstBatch||(this.firstBatch=d),this.length+=1;d.append(a,b,c)};BatchList.prototype.fetch=function(){var a=this.firstBatch;if(a&&a.isClosed)return this.firstBatch=a.next,--this.length,a};
BatchList.prototype.restore=function(a){this.firstBatch=a;this.length+=1};var Socket=exports.Socket=function(a){var b=this;EventEmitter.call(this);this.type=a;this._zmq=new zmq.SocketBinding(defaultContext(),types[a]);this._isFlushingWrites=this._isFlushingReads=this._paused=!1;this._outgoing=new BatchList;this._zmq.onReadReady=function(){b._flushReads()};this._zmq.onSendReady=function(){b._flushWrites()}};util.inherits(Socket,EventEmitter);Socket.prototype.pause=function(){this._paused=!0};
Socket.prototype.resume=function(){this._paused=!1;this._flushReads();this._flushWrites()};Socket.prototype.ref=function(){this._zmq.ref()};Socket.prototype.unref=function(){this._zmq.unref()};Socket.prototype.read=function(){var a=[];if(this._zmq.state!==zmq.STATE_READY)return null;if(this._zmq.getsockopt(zmq.ZMQ_EVENTS)&zmq.ZMQ_POLLIN){do a.push(this._zmq.recv());while(this._zmq.getsockopt(zmq.ZMQ_RCVMORE));return a}return null};
Socket.prototype.setsockopt=function(a,b){this._zmq.setsockopt(opts[a]||a,b);return this};Socket.prototype.getsockopt=function(a){return this._zmq.getsockopt(opts[a]||a)};Object.keys(opts).forEach(function(a){Socket.prototype.__defineGetter__(a,function(){return this._zmq.getsockopt(opts[a])});Socket.prototype.__defineSetter__(a,function(b){"string"==typeof b&&(b=new Buffer(b,"utf8"));return this._zmq.setsockopt(opts[a],b)})});
Socket.prototype.bind=function(a,b){var c=this;this._zmq.bind(a,function(d){if(d)return b&&b(d);c._flushReads();c._flushWrites();c.emit("bind",a);b&&b()});return this};Socket.prototype.bindSync=function(a){this._zmq.bindSync(a);return this};Socket.prototype.unbind=function(a,b){if(zmq.ZMQ_CAN_UNBIND){var c=this;this._zmq.unbind(a,function(d){if(d)return b&&b(d);c.emit("unbind",a);c._flushReads();c._flushWrites();b&&b()})}else b&&b();return this};
Socket.prototype.unbindSync=function(a){zmq.ZMQ_CAN_UNBIND&&this._zmq.unbindSync(a);return this};Socket.prototype.connect=function(a){this._zmq.connect(a);return this};Socket.prototype.disconnect=function(a){zmq.ZMQ_CAN_DISCONNECT&&this._zmq.disconnect(a);return this};
Socket.prototype.monitor=function(a,b){if(zmq.ZMQ_CAN_MONITOR){var c=this;c._zmq.onMonitorEvent=function(a,b,e){c.emit(events[a],b,e)};c._zmq.onMonitorError=function(a){c.emit("monitor_error",a)};this._zmq.monitor(a,b)}else throw Error("Monitoring support disabled check zmq version is \x3e 3.2.1 and recompile this addon");return this};Socket.prototype.unmonitor=function(){zmq.ZMQ_CAN_MONITOR&&this._zmq.unmonitor();return this};Socket.prototype.subscribe=function(a){this._subscribe=a;return this};
Socket.prototype.unsubscribe=function(a){this._unsubscribe=a;return this};Socket.prototype.send=function(a,b,c){b|=0;if(Array.isArray(a))for(var d=0,f=a.length;d<f;d++){var e=d===f-1;this._outgoing.append(a[d],e?b:b|zmq.ZMQ_SNDMORE,e?c:void 0)}else this._outgoing.append(a,b,c);this._outgoing.canSend()?(this._zmq.pending=!0,this._flushWrites()):this._zmq.pending=!1;return this};
Socket.prototype._flushRead=function(){var a=this._zmq.readv();if(!a)return!1;1===a.length?this.emit("message",a[0]):this.emit.apply(this,["message"].concat(a));return!0};Socket.prototype._flushWrite=function(){var a=this._outgoing.fetch();if(!a)return this._zmq.pending=!1;try{if(this._zmq.sendv(a.content))return this._zmq.pending=this._outgoing.canSend(),a.invokeSent(this),!0;this._outgoing.restore(a);return!1}catch(b){return this._zmq.pending=this._outgoing.canSend(),a.invokeError(this,b),!1}};
Socket.prototype._flushReads=function(){if(!this._paused&&!this._isFlushingReads){this._isFlushingReads=!0;var a;do try{a=this._flushRead()}catch(b){this._isFlushingReads=!1;this.emit("error",b);return}while(a);this._isFlushingReads=!1;this._flushWrites()}};Socket.prototype._flushWrites=function(){if(!this._paused&&!this._isFlushingWrites){this._isFlushingWrites=!0;var a;do try{a=this._flushWrite()}catch(b){this._isFlushingWrites=!1;this.emit("error",b);return}while(a);this._isFlushingWrites=!1}};
Socket.prototype.close=function(){this._zmq.close();return this};exports.socket=exports.createSocket=function(a,b){var c=new Socket(a),d;for(d in b)c[d]=b[d];return c};exports.Context.setMaxThreads=function(a){if(!zmq.ZMQ_CAN_SET_CTX)throw Error("Setting of context options disabled, check zmq version is \x3e\x3d 3.2.1 and recompile this addon");defaultContext().setOpt(zmq.ZMQ_IO_THREADS,a)};
exports.Context.getMaxThreads=function(){if(!zmq.ZMQ_CAN_SET_CTX)throw Error("Getting of context options disabled, check zmq version is \x3e\x3d 3.2.1 and recompile this addon");return defaultContext().getOpt(zmq.ZMQ_IO_THREADS)};exports.Context.setMaxSockets=function(a){if(!zmq.ZMQ_CAN_SET_CTX)throw Error("Setting of context options disabled, check zmq version is \x3e\x3d 3.2.1 and recompile this addon");defaultContext().setOpt(zmq.ZMQ_MAX_SOCKETS,a)};
exports.Context.getMaxSockets=function(){if(!zmq.ZMQ_CAN_SET_CTX)throw Error("Getting of context options disabled, check zmq version is \x3e\x3d 3.2.1 and recompile this addon");return defaultContext().getOpt(zmq.ZMQ_MAX_SOCKETS)};
function proxy(a,b,c){switch(a.type+"/"+b.type){case "push/pull":case "pull/push":case "xpub/xsub":c?(a.on("message",function(a){b.send(a)}),b.on("message",function(b){a.send(b);c.send(b)})):(a.on("message",function(a){b.send(a)}),b.on("message",function(b){a.send(b)}));break;case "router/dealer":case "xrep/xreq":c?(a.on("message",function(a,c,e){b.send([a,c,e])}),b.on("message",function(b,f,e){a.send([b,f,e]);c.send(e)})):(a.on("message",function(a,c,e){b.send([a,c,e])}),b.on("message",function(b,
c,e){a.send([b,c,e])}));break;default:throw Error("wrong socket order to proxy");}}exports.proxy=proxy;